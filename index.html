<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Infrastructure Monitoring Dashboard</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
body{margin:0;font-family:"Segoe UI",Arial;background:#f3f4f6;color:#111827}
.header{background:#111827;color:white;padding:15px;font-size:20px;font-weight:bold}
.header span{float:right;font-size:14px}
.container{padding:20px}
.grid-summary{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:15px;margin-bottom:20px}
.card{background:white;padding:15px;border-radius:12px;box-shadow:0 4px 12px rgba(0,0,0,0.08);transition:.3s}
.card:hover{transform:translateY(-4px)}
.progress-bg{background:#e5e7eb;height:18px;border-radius:10px;margin-top:8px;overflow:hidden}
.progress-bar{height:100%;background:#16a34a;width:0%;transition:width 1s ease}
.section-title{font-weight:bold;margin-top:25px;margin-bottom:10px}
.grid-2{display:grid;grid-template-columns:repeat(auto-fit,minmax(400px,1fr));gap:20px}
.log-box{background:#0f172a;color:#e5e7eb;padding:10px;height:300px;overflow-y:auto;border-radius:8px;font-family:monospace;font-size:13px}
.chart-container{background:white;padding:15px;border-radius:12px;box-shadow:0 4px 12px rgba(0,0,0,0.08)}
table{width:100%;border-collapse:collapse;background:white;border-radius:12px;overflow:hidden;margin-top:10px}
th,td{padding:10px;text-align:center}
th{background:#111827;color:white}
tr:nth-child(even){background:#f9fafb}
.badge{padding:5px 10px;border-radius:20px;color:white;font-size:12px}
.up{background:#16a34a}
.down{background:#dc2626}
.unknown{background:#f59e0b}
.alert{background:#dc2626;color:white;padding:6px 12px;border-radius:20px;font-size:12px;display:inline-block;margin-left:10px;animation:blink 1s infinite}
@keyframes blink{50%{opacity:0.4}}
.footer{margin-top:20px;font-size:13px;color:#6b7280}
</style>
</head>

<body>

<div class="header">
Infrastructure Monitoring Dashboard
<span id="realtimeClock"></span>
</div>

<div class="container">

<div class="grid-summary">
<div class="card"><h4>Total Servers</h4><h2 id="total">0</h2></div>
<div class="card"><h4>Up</h4><h2 id="up" style="color:#16a34a">0</h2></div>
<div class="card"><h4>Down</h4><h2 id="down" style="color:#dc2626">0</h2></div>
<div class="card"><h4>Unknown</h4><h2 id="unknown" style="color:#f59e0b">0</h2></div>
<div class="card">
<h4>24h Availability</h4>
<div class="progress-bg"><div class="progress-bar" id="uptimeBar"></div></div>
<h2 id="uptimeText">0%</h2>
</div>
</div>

<div class="section-title">
Security Logs
<span id="ddosAlert"></span>
</div>

<div class="grid-2">
<div>
<h4>Elasticsearch Logs</h4>
<div class="log-box" id="elasticLog"></div>
</div>
<div>
<h4>Zabbix Problem Log</h4>
<div class="log-box" id="problemLog">Monitoring Active...</div>
</div>
</div>

<div class="section-title">Security Trend (Realtime)</div>
<div class="grid-2">
<div class="chart-container">
<h4>DDoS Activity</h4>
<canvas id="ddosChart"></canvas>
</div>
<div class="chart-container">
<h4>Bruteforce Attempts</h4>
<canvas id="bruteChart"></canvas>
</div>
</div>

<div class="section-title">Server Detail Overview</div>
<table>
<thead>
<tr>
<th>Server</th>
<th>IP</th>
<th>CPU (%)</th>
<th>Memory (%)</th>
<th>Bandwidth In</th>
<th>Bandwidth Out</th>
<th>Status</th>
</tr>
</thead>
<tbody id="hostTable"></tbody>
</table>

<div class="footer">Last Updated: <span id="time">-</span></div>

</div>

<script>

let labels=[], bruteData=[], ddosData=[];
const MAX_POINTS=30;

const bruteChart=new Chart(document.getElementById("bruteChart"),{
type:"line",
data:{
labels:labels,
datasets:[{
label:"Bruteforce",
data:bruteData,
borderColor:"red",
backgroundColor:"rgba(255,0,0,0.1)",
fill:true,
tension:0.4
}]
},
options:{animation:{duration:600}}
});

const ddosChart=new Chart(document.getElementById("ddosChart"),{
type:"line",
data:{
labels:labels,
datasets:[{
label:"DDoS",
data:ddosData,
borderColor:"blue",
backgroundColor:"rgba(0,0,255,0.1)",
fill:true,
tension:0.4
}]
},
options:{animation:{duration:600}}
});

function updateClock(){
document.getElementById("realtimeClock").innerText=new Date().toLocaleTimeString();
}
setInterval(updateClock,1000);

async function loadData(){
try{
const res=await fetch("/api/dashboard");
const data=await res.json();

document.getElementById("total").innerText=data.total;
document.getElementById("up").innerText=data.up;
document.getElementById("down").innerText=data.down;
document.getElementById("unknown").innerText=data.unknown;
document.getElementById("uptimeText").innerText=data.daily_uptime+"%";
document.getElementById("uptimeBar").style.width=data.daily_uptime+"%";
document.getElementById("time").innerText=data.time;

/* ===== Smooth Sliding Chart ===== */
if(labels.length>=MAX_POINTS){
labels.shift();
bruteData.shift();
ddosData.shift();
}

labels.push(new Date().toLocaleTimeString());
bruteData.push(data.bruteforce||0);
ddosData.push(data.ddos||0);

bruteChart.update();
ddosChart.update();

/* ===== DDOS ALERT ===== */
const alertBox=document.getElementById("ddosAlert");
if(data.ddos>0){
alertBox.innerHTML='<span class="alert">DDoS DETECTED</span>';
}else{
alertBox.innerHTML='';
}

/* ===== Host Table ===== */
let table="";
data.hosts.forEach(h=>{

let statusClass="unknown",statusText="Unknown";

if(Number(h.available)===1){
statusClass="up";statusText="Up";
}else if(Number(h.available)===0){
statusClass="down";statusText="Down";
}

table+=`
<tr>
<td>${h.host}</td>
<td>${h.ip||"-"}</td>
<td>${Number(h.cpu||0).toFixed(1)}</td>
<td>${Number(h.ram||0).toFixed(1)}</td>
<td>${Number(h.net_in||0).toFixed(2)} ${h.net_in_unit||""}</td>
<td>${Number(h.net_out||0).toFixed(2)} ${h.net_out_unit||""}</td>
<td><span class="badge ${statusClass}">${statusText}</span></td>
</tr>`;
});

document.getElementById("hostTable").innerHTML=table;

/* ===== Logs ===== */
let elasticHTML="";
data.logs.slice().reverse().forEach(log=>{
elasticHTML+=`<div>[${log.time}] ${log.message}</div>`;
});
const elasticBox=document.getElementById("elasticLog");
elasticBox.innerHTML=elasticHTML;
elasticBox.scrollTop=elasticBox.scrollHeight;

}catch(e){
console.log("Dashboard error:",e);
}
}

loadData();
setInterval(loadData,2000);

</script>

</body>
</html>
